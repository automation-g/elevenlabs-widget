<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Purple Assistant – BETA</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      text-align: left;   /* all text left by default */
      padding: 40px;
    }

    h2 {
      text-align: left;   /* keep title left too (remove this if you want centered) */
    }

    #widget {
      display: flex;
      justify-content: flex-end;  /* widget goes to the right */
      margin-top: 30px;
    }

    .info {
      margin-top: 20px;
      font-size: 16px;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>Welcome to Purple Assistant - BETA</h2>
  <p>Available 24/7</p>
  <div class="info" id="userInfo">Retrieving your details…</div>
  <div id="widget"></div>

  <!-- Load Microsoft Teams SDK (v2) -->
  <script src="https://res.cdn.office.net/teams-js/2.13.0/js/MicrosoftTeams.min.js"></script>

  <!-- Attribution hider (unchanged) -->
  <script>
    // ElevenLabs attribution hider (same as before)
    function hideElevenLabsAttribution() {
      let attributionFound = false;
      let cleanupAttempts = 0;
      const maxAttempts = 5;

      function hideElementsWithAttribution(container = document) {
        const elementsToCheck = container.querySelectorAll('*');
        let hiddenCount = 0;

        elementsToCheck.forEach(el => {
          const text = el.textContent || el.innerText || '';
          if (text.includes('Powered by ElevenLabs') || 
              text.includes('Powered by Eleven Labs') ||
              (text.includes('ElevenLabs') && text.includes('Powered')) ||
              text.includes('elevenlabs.io') ||
              text.includes('conversational-ai')) {

            attributionFound = true;
            el.style.display = 'none';
            el.style.visibility = 'hidden';
            el.style.opacity = '0';
            el.style.height = '0px';
            el.style.width = '0px';
            el.style.overflow = 'hidden';

            if (el.parentElement && el.parentElement.textContent.trim() === text.trim()) {
              el.parentElement.style.display = 'none';
            }

            hiddenCount++;
          }

          if (el.tagName === 'A') {
            const href = el.href || '';
            if (href.includes('elevenlabs.io') || href.includes('conversational-ai')) {
              el.style.display = 'none';
              el.style.visibility = 'hidden';
              el.style.opacity = '0';
              hiddenCount++;
              attributionFound = true;
            }
          }
        });

        return hiddenCount;
      }

      function processShadowDOMs() {
        const widgets = document.querySelectorAll('elevenlabs-convai, *');
        widgets.forEach(widget => {
          try {
            if (widget.shadowRoot) {
              hideElementsWithAttribution(widget.shadowRoot);

              let style = widget.shadowRoot.querySelector('#attribution-hider-style');
              if (!style) {
                style = document.createElement('style');
                style.id = 'attribution-hider-style';
                style.textContent = `
                  p[class*="whitespace-nowrap"] { display: none !important; }
                  *[class*="opacity-30"] { display: none !important; }
                  a[href*="elevenlabs"] { display: none !important; }
                  a[href*="conversational-ai"] { display: none !important; }
                  *:has(a[href*="elevenlabs"]) { display: none !important; }
                `;
                widget.shadowRoot.appendChild(style);
              }
            }
          } catch (e) {
            console.log('Could not access shadow DOM:', e);
          }
        });
      }

      function performCleanup() {
        cleanupAttempts++;
        if (cleanupAttempts > maxAttempts) return false;

        hideElementsWithAttribution();
        processShadowDOMs();

        return attributionFound;
      }

      performCleanup();
      let observer = new MutationObserver(() => performCleanup());
      observer.observe(document.body, { childList: true, subtree: true });

      setInterval(performCleanup, 2000);
    }

    function injectGlobalCSS() {
      const style = document.createElement('style');
      style.textContent = `
        a[href*="elevenlabs.io"], a[href*="conversational-ai"] { display: none !important; }
        p[class*="whitespace-nowrap"] { display: none !important; }
        *:has(> a[href*="elevenlabs"]:only-child) { display: none !important; }
        .attribution, .powered-by, [class*="attribution"] { display: none !important; }
      `;
      document.head.appendChild(style);
    }

    function initAttributionHider() {
      injectGlobalCSS();
      hideElevenLabsAttribution();
    }

    window.addEventListener('load', initAttributionHider);
  </script>

  <!-- Teams-aware identity + widget injection -->
  <script>
    function nameFromEmail(email) {
      if (!email) return 'Unknown User';
      const local = email.split('@')[0].split('+')[0];
      const parts = local.split(/[._-]+/).filter(Boolean)
        .map(p => p.replace(/\d+/g, ''))
        .filter(Boolean)
        .map(p => p.charAt(0).toUpperCase() + p.slice(1));
      return parts.join(' ') || 'Unknown User';
    }

    function decodeJwt(token) {
      try {
        const b = token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');
        const s = decodeURIComponent(atob(b).split('').map(c => '%' + ('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        return JSON.parse(s);
      } catch { return {}; }
    }

    async function getEmail() {
      try {
        await microsoftTeams.app.initialize();
        const ctx = await microsoftTeams.app.getContext();
        if (ctx?.user?.userPrincipalName) return ctx.user.userPrincipalName;
      } catch {}
      try {
        const token = await microsoftTeams.authentication.getAuthToken();
        const claims = decodeJwt(token);
        return claims.preferred_username || claims.upn;
      } catch {}
      const params = new URLSearchParams(location.search);
      return params.get('email') || 'unknown@example.com';
    }

    async function initFromTeamsEmail() {
      const email = await getEmail();
      const name  = nameFromEmail(email);

      const info = document.getElementById('userInfo');
      if (info) {
        info.innerHTML = `<strong>Name:</strong> ${name}<br><strong>Email:</strong> ${email}`;
      }

      const widget = document.createElement('elevenlabs-convai');
      widget.setAttribute('agent-id', 'agent_4901k3gjds1eexs83j5a7pv4xaaz');
      widget.setAttribute('dynamic-variables', JSON.stringify({ name, email }));
      document.getElementById('widget').appendChild(widget);

      const script = document.createElement('script');
      script.src = 'https://unpkg.com/@elevenlabs/convai-widget-embed';
      script.async = true;
      document.body.appendChild(script);
    }

    window.addEventListener('load', initFromTeamsEmail);
  </script>
</body>
</html>
