<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purple Assistant BETA</title>
  
  <style>
    /* Color scheme */
    :root {
      --header: #532E79;
      --header-accent: #B98330;
      --business: #6B4490;
      --application: #8B6BB1;
      --data: #A590C5;
      --technology: #C5B3D8;
      --customer360: #B98330;
      --financial: #D4A556;
      --shared: #9B7EBD;
      --integration: #8B5FA8;
      --text: #2c2c2c;
      --white: #ffffff;
      --light-bg: #f8f6fa;
      --accent: #E8DCEF;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--light-bg);
      padding: 20px;
      color: var(--text);
    }

    .container {
      max-width: 800px;
      margin: 0;
      margin-bottom: 100px; /* Keep bottom area free for chat widget */
    }

    .header-section {
      background: var(--white);
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      border-top: 4px solid var(--header);
    }

    h1 {
      color: var(--header);
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .beta-badge {
      display: inline-block;
      background: var(--header-accent);
      color: var(--white);
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
      vertical-align: middle;
    }

    .status {
      color: var(--integration);
      font-size: 14px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #4ade80;
      border-radius: 50%;
      display: inline-block;
    }

    .info-section {
      background: var(--white);
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .info-title {
      color: var(--business);
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
    }

    #userInfo {
      background: var(--accent);
      padding: 15px;
      border-left: 3px solid var(--header-accent);
      text-align: left;
    }

    .loading {
      color: var(--shared);
      font-style: italic;
    }

    .user-field {
      margin: 8px 0;
      color: var(--text);
    }

    .field-label {
      font-weight: 600;
      color: var(--business);
      display: inline-block;
      min-width: 60px;
    }

    .field-value {
      color: var(--text);
    }

    /* Widget positioning - bottom right */
    #widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    /* Hide ElevenLabs attribution */
    a[href*="elevenlabs"],
    p[class*="whitespace-nowrap"],
    [class*="attribution"],
    [class*="powered"] {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-section">
      <h1>
        Purple Assistant
        <span class="beta-badge">BETA</span>
      </h1>
      <div class="status">
        <span class="status-dot"></span>
        <span>Available 24/7</span>
      </div>
    </div>

    <div class="info-section">
      <div class="info-title">User Information</div>
      <div id="userInfo">
        <div class="loading">Retrieving your details...</div>
      </div>
    </div>

    <div class="info-section" style="margin-top: 20px;">
      <div class="info-title">Data Source Information</div>
      <div id="dataSourceInfo">
        <div class="loading">Checking data sources...</div>
      </div>
    </div>

    <div class="info-section" style="margin-top: 20px;">
      <div class="info-title">Teams App Information</div>
      <div id="teamsAppInfo">
        <div class="loading">Loading Teams app details...</div>
      </div>
    </div>

    <div class="info-section" style="margin-top: 20px;">
      <div class="info-title">Teams Context Debug</div>
      <div id="teamsDebugInfo">
        <div class="loading">Loading Teams context details...</div>
      </div>
    </div>


    <div class="info-section" style="margin-top: 20px;">
      <div class="info-title">How to Get Started</div>
      <div style="color: var(--text); line-height: 1.5;">
        Click the widget in the bottom-right corner to initiate a conversation and get assistance with your questions.
      </div>
    </div>
  </div>

  <!-- Widget container (bottom right) -->
  <div id="widget"></div>

  <!-- Microsoft Teams SDK -->
  <script src="https://res.cdn.office.net/teams-js/2.13.0/js/MicrosoftTeams.min.js"></script>

  <script>
    // Configuration - Get agent ID from environment variables or build-time replacement
    const AGENT_ID = window.ENV?.ELEVENLABS_AGENT_ID || '__ELEVENLABS_AGENT_ID__';

    // Hide ElevenLabs attribution
    function hideAttribution() {
      const style = document.createElement('style');
      style.textContent = `
        a[href*="elevenlabs"],
        a[href*="conversational-ai"],
        p[class*="whitespace-nowrap"],
        *[class*="opacity-30"],
        [class*="attribution"],
        [class*="powered"],
        *:has(> a[href*="elevenlabs"]:only-child) {
          display: none !important;
          visibility: hidden !important;
        }
      `;
      document.head.appendChild(style);

      // Check for shadow DOM elements periodically
      let checks = 0;
      const interval = setInterval(() => {
        checks++;
        const widgets = document.querySelectorAll('elevenlabs-convai');
        widgets.forEach(widget => {
          if (widget.shadowRoot) {
            const shadowStyle = document.createElement('style');
            shadowStyle.textContent = style.textContent;
            widget.shadowRoot.appendChild(shadowStyle);
          }
        });
        
        // Stop after 10 checks
        if (checks > 10) clearInterval(interval);
      }, 1000);
    }

    // Extract name from email
    function nameFromEmail(email) {
      if (!email) return 'Unknown User';
      const local = email.split('@')[0].split('+')[0];
      const parts = local
        .split(/[._-]+/)
        .filter(Boolean)
        .map(p => p.replace(/\d+/g, ''))
        .filter(Boolean)
        .map(p => p.charAt(0).toUpperCase() + p.slice(1));
      return parts.join(' ') || 'Unknown User';
    }

    // Decode JWT token
    function decodeJwt(token) {
      try {
        const base64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
        const jsonStr = decodeURIComponent(
          atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')
        );
        return JSON.parse(jsonStr);
      } catch {
        return {};
      }
    }

    // Generate fresh token using client credentials flow
    async function generateFreshToken() {
      // Get credentials from environment variables or fallback to build-time replacements
      const tenantId = window.ENV?.AZURE_TENANT_ID || '__AZURE_TENANT_ID__';
      const clientId = window.ENV?.AZURE_CLIENT_ID || '__AZURE_CLIENT_ID__';
      const clientSecret = window.ENV?.AZURE_CLIENT_SECRET || '__AZURE_CLIENT_SECRET__';

      // Check if credentials are properly configured
      if (tenantId.startsWith('__') || clientId.startsWith('__') || clientSecret.startsWith('__')) {
        console.error('Azure credentials not properly configured. Check environment variables.');
        return null;
      }

      const tokenUrl = `https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/token`;
      const params = new URLSearchParams();
      params.append('client_id', clientId);
      params.append('client_secret', clientSecret);
      params.append('scope', 'https://graph.microsoft.com/.default');
      params.append('grant_type', 'client_credentials');

      try {
        const response = await fetch(tokenUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params
        });

        if (response.ok) {
          const data = await response.json();
          return data.access_token;
        } else {
          console.error('Token generation failed:', response.status, response.statusText);
          return null;
        }
      } catch (e) {
        console.error('Token generation error:', e);
        return null;
      }
    }

    // Get user information from Microsoft Graph API using email
    async function getUserFromGraph(userEmail) {
      try {
        // Generate fresh token for the request
        const freshToken = await generateFreshToken();
        
        if (!freshToken) {
          return {
            source: 'Graph API Failed',
            error: 'Unable to generate authentication token',
            name: 'Token Error',
            email: userEmail || 'unknown@example.com'
          };
        }

        // If we have an email, look up the specific user
        let endpoint = 'https://graph.microsoft.com/v1.0/users';
        if (userEmail && userEmail !== 'unknown@example.com') {
          endpoint = `https://graph.microsoft.com/v1.0/users/${userEmail}`;
        }
        
        const response = await fetch(endpoint, {
          headers: {
            'Authorization': `Bearer ${freshToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const user = await response.json();
          return {
            name: user.displayName || 'Unknown User',
            email: user.userPrincipalName || user.mail || userEmail || 'unknown@example.com',
            source: 'Microsoft Graph API',
            rawData: {
              displayName: user.displayName,
              userPrincipalName: user.userPrincipalName,
              mail: user.mail,
              givenName: user.givenName,
              surname: user.surname,
              jobTitle: user.jobTitle,
              department: user.department,
              officeLocation: user.officeLocation,
              mobilePhone: user.mobilePhone,
              businessPhones: user.businessPhones
            }
          };
        } else {
          // Handle HTTP error responses
          let errorDetails = `HTTP ${response.status}: ${response.statusText}`;
          try {
            const errorBody = await response.json();
            if (errorBody.error) {
              errorDetails += ` - ${errorBody.error.code}: ${errorBody.error.message}`;
            }
          } catch (parseError) {
            // If we can't parse the error response, just use the status
          }
          
          console.debug('Graph API HTTP error:', errorDetails);
          return {
            source: 'Graph API Failed',
            error: errorDetails,
            name: 'Graph API Error',
            email: userEmail || 'unknown@example.com'
          };
        }
      } catch (e) {
        console.debug('Graph API call failed:', e);
        let errorMessage = e.message || 'Unknown error';
        
        // Add more specific error context
        if (e.name === 'TypeError' && e.message.includes('fetch')) {
          errorMessage = 'Network error - unable to reach Graph API';
        }
        
        return {
          source: 'Graph API Failed',
          error: errorMessage,
          name: 'Graph API Error',
          email: userEmail || 'unknown@example.com'
        };
      }
    }


    // Get user information from Teams or URL (fallback)
    async function getUserFromTeams() {
      // Try Teams context
      try {
        await microsoftTeams.app.initialize();
        const context = await microsoftTeams.app.getContext();
        console.log('Full Teams context:', context);
        console.log('User object:', context?.user);
        
        if (context?.user?.userPrincipalName) {
          return {
            name: context.user.displayName || nameFromEmail(context.user.userPrincipalName),
            email: context.user.userPrincipalName,
            source: 'Teams Context',
            fullContext: context, // Store full context for app info extraction
            teamsData: {
              // Core user data
              displayName: context.user.displayName,
              userPrincipalName: context.user.userPrincipalName,
              id: context.user.id,
              preferredLanguage: context.user.preferredLanguage,
              // Additional user fields that might be available
              givenName: context.user.givenName,
              surname: context.user.surname,
              email: context.user.email,
              // Tenant context
              tenantId: context.user.tenant?.id,
              tenantDisplayName: context.user.tenant?.displayName,
              // App context
              appSessionId: context.app?.sessionId,
              theme: context.app?.theme,
              // Page context
              frameContext: context.page?.frameContext,
              subPageId: context.page?.subPageId,
              // Team context if available
              teamId: context.team?.internalId,
              teamDisplayName: context.team?.displayName,
              teamType: context.team?.type,
              // Channel context if available  
              channelId: context.channel?.id,
              channelDisplayName: context.channel?.displayName,
              channelType: context.channel?.membershipType,
              // Meeting context if available
              meetingId: context.meeting?.id,
              // Debug: show all available user properties
              allUserProperties: Object.keys(context.user || {}),
              // Debug: raw user object (first 5 properties)
              rawUserSample: Object.fromEntries(
                Object.entries(context.user || {}).slice(0, 10)
              )
            }
          };
        }
      } catch (e) {
        console.debug('Not in Teams context');
      }

      // Try SSO token
      try {
        const token = await microsoftTeams.authentication.getAuthToken();
        const claims = decodeJwt(token);
        if (claims.preferred_username || claims.upn) {
          const email = claims.preferred_username || claims.upn;
          return {
            name: claims.name || nameFromEmail(email),
            email: email,
            source: 'SSO Token',
            ssoData: {
              name: claims.name,
              preferred_username: claims.preferred_username,
              upn: claims.upn,
              given_name: claims.given_name,
              family_name: claims.family_name
            }
          };
        }
      } catch (e) {
        console.debug('No SSO token available');
      }

      // Fallback to URL parameter
      const params = new URLSearchParams(window.location.search);
      const email = params.get('email') || 'unknown@example.com';
      return {
        name: nameFromEmail(email),
        email: email,
        source: 'URL Parameter'
      };
    }

    // Initialize the application
    async function init() {
      // First get user email from Teams context
      const teamsUserInfo = await getUserFromTeams();
      let userEmail = teamsUserInfo.email;
      
      // Try to get full user info from Graph API using the email
      let userInfo = await getUserFromGraph(userEmail);
      let graphApiError = null;
      
      // Check if Graph API failed and preserve error info
      if (!userInfo || userInfo.error) {
        if (userInfo && userInfo.error) {
          graphApiError = userInfo.error;
        }
        
        // Use Teams context data as fallback
        userInfo = {
          ...teamsUserInfo,
          graphApiError: graphApiError
        };
      } else {
        // Merge Teams context with Graph API data
        userInfo = {
          ...userInfo,
          fullContext: teamsUserInfo.fullContext,
          teamsData: teamsUserInfo.teamsData
        };
      }

      // Update User Information UI
      const userInfoElement = document.getElementById('userInfo');
      if (userInfoElement) {
        userInfoElement.innerHTML = `
          <div class="user-field">
            <span class="field-label">Name:</span>
            <span class="field-value">${userInfo.name}</span>
          </div>
          <div class="user-field">
            <span class="field-label">Email:</span>
            <span class="field-value">${userInfo.email}</span>
          </div>
        `;
      }

      // Update Data Source Information UI
      const dataSourceElement = document.getElementById('dataSourceInfo');
      if (dataSourceElement) {
        let sourceContent = `
          <div class="user-field">
            <span class="field-label">Source:</span>
            <span class="field-value" style="color: ${userInfo.source === 'Microsoft Graph API' ? 'green' : 'orange'};">
              ${userInfo.source}
            </span>
          </div>
        `;

        if (userInfo.rawData) {
          sourceContent += `
            <div class="user-field" style="margin-top: 10px;">
              <span class="field-label">Graph Data:</span>
            </div>
            <div style="margin-left: 20px; font-size: 12px; color: var(--shared);">
              ${Object.entries(userInfo.rawData)
                .filter(([key, value]) => value !== null && value !== undefined && value !== '')
                .map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`)
                .join('')}
            </div>
          `;
        }

        if (userInfo.teamsData) {
          sourceContent += `
            <div class="user-field" style="margin-top: 10px;">
              <span class="field-label">Teams Data:</span>
            </div>
            <div style="margin-left: 20px; font-size: 12px; color: var(--shared);">
              ${Object.entries(userInfo.teamsData)
                .filter(([key, value]) => value !== null && value !== undefined && value !== '')
                .map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`)
                .join('')}
            </div>
          `;
        }

        if (userInfo.ssoData) {
          sourceContent += `
            <div class="user-field" style="margin-top: 10px;">
              <span class="field-label">SSO Token Data:</span>
            </div>
            <div style="margin-left: 20px; font-size: 12px; color: var(--shared);">
              ${Object.entries(userInfo.ssoData)
                .filter(([key, value]) => value !== null && value !== undefined && value !== '')
                .map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`)
                .join('')}
            </div>
          `;
        }

        if (userInfo.error || userInfo.graphApiError) {
          const errorToShow = userInfo.error || userInfo.graphApiError;
          sourceContent += `
            <div class="user-field" style="color: red;">
              <span class="field-label">Graph API Error:</span>
              <span class="field-value">${errorToShow}</span>
            </div>
          `;
        }

        // Show detailed Graph API error information
        if (userInfo.graphApiError) {
          sourceContent += `
            <div class="user-field" style="margin-top: 10px;">
              <span class="field-label">Graph API Error Details:</span>
            </div>
            <div style="margin-left: 20px; font-size: 11px; color: red; background: #ffe6e6; padding: 10px; border-radius: 4px; border-left: 4px solid red;">
              <div><strong>Error:</strong> ${userInfo.graphApiError}</div>
              <div style="margin-top: 5px;"><strong>Solution:</strong> This usually indicates authentication or permission issues. Try using Teams app manifest version 1.05 which removes problematic SSO configuration.</div>
            </div>
          `;
        }

        dataSourceElement.innerHTML = sourceContent;
      }

      // Display Teams App Information
      const teamsAppElement = document.getElementById('teamsAppInfo');
      if (teamsAppElement && userInfo.fullContext) {
        const context = userInfo.fullContext;
        let appContent = '';

        // App manifest information
        if (context.app) {
          appContent += `
            <div class="user-field">
              <span class="field-label">App ID:</span>
              <span class="field-value">${context.app.id || '[Not Available]'}</span>
            </div>
            <div class="user-field">
              <span class="field-label">App Version:</span>
              <span class="field-value" style="font-weight: bold; color: var(--header);">${context.app.version || '[Not Available]'}</span>
            </div>
            <div class="user-field">
              <span class="field-label">Session ID:</span>
              <span class="field-value">${context.app.sessionId || '[Not Available]'}</span>
            </div>
            <div class="user-field">
              <span class="field-label">Theme:</span>
              <span class="field-value">${context.app.theme || '[Not Available]'}</span>
            </div>
          `;
        }

        // Host information
        if (context.app?.host) {
          appContent += `
            <div class="user-field">
              <span class="field-label">Host Name:</span>
              <span class="field-value">${context.app.host.name || '[Not Available]'}</span>
            </div>
            <div class="user-field">
              <span class="field-label">Host Version:</span>
              <span class="field-value">${context.app.host.clientSupportedSDKVersion || '[Not Available]'}</span>
            </div>
          `;
        }

        // Locale information
        if (context.app?.locale) {
          appContent += `
            <div class="user-field">
              <span class="field-label">App Locale:</span>
              <span class="field-value">${context.app.locale || '[Not Available]'}</span>
            </div>
          `;
        }

        // Debug: Show all available app properties
        if (context.app && Object.keys(context.app).length > 0) {
          appContent += `
            <div class="user-field" style="margin-top: 10px;">
              <span class="field-label">Available App Properties:</span>
              <span class="field-value">${Object.keys(context.app).join(', ')}</span>
            </div>
            <div class="user-field" style="margin-top: 5px;">
              <span class="field-label">Raw App Data:</span>
            </div>
            <div style="margin-left: 20px; font-size: 11px; color: var(--shared); background: var(--accent); padding: 10px; border-radius: 4px;">
              ${Object.entries(context.app)
                .slice(0, 8)
                .map(([key, value]) => `<div><strong>${key}:</strong> ${JSON.stringify(value) || '[undefined]'}</div>`)
                .join('')}
            </div>
          `;
        }

        if (appContent) {
          teamsAppElement.innerHTML = appContent;
        } else {
          teamsAppElement.innerHTML = `
            <div class="user-field">
              <span class="field-label">Status:</span>
              <span class="field-value" style="color: orange;">No app information available</span>
            </div>
          `;
        }
      } else if (teamsAppElement) {
        teamsAppElement.innerHTML = `
          <div class="user-field">
            <span class="field-label">Status:</span>
            <span class="field-value" style="color: orange;">Not running in Teams context</span>
          </div>
        `;
      }

      // Display complete Teams context for debugging
      const teamsDebugElement = document.getElementById('teamsDebugInfo');
      if (teamsDebugElement && userInfo.teamsData) {
        let debugContent = `
          <div class="user-field">
            <span class="field-label">Available Properties:</span>
            <span class="field-value">${userInfo.teamsData.allUserProperties?.join(', ') || 'None'}</span>
          </div>
        `;

        if (userInfo.teamsData.rawUserSample) {
          debugContent += `
            <div class="user-field" style="margin-top: 10px;">
              <span class="field-label">Raw User Data Sample:</span>
            </div>
            <div style="margin-left: 20px; font-size: 11px; color: var(--shared); background: var(--accent); padding: 10px; border-radius: 4px;">
              ${Object.entries(userInfo.teamsData.rawUserSample)
                .map(([key, value]) => `<div><strong>${key}:</strong> ${value || '[undefined]'}</div>`)
                .join('')}
            </div>
          `;
        }

        // Show specific name-related fields
        debugContent += `
          <div class="user-field" style="margin-top: 10px;">
            <span class="field-label">Name Fields:</span>
          </div>
          <div style="margin-left: 20px; font-size: 11px; color: var(--shared); background: var(--accent); padding: 10px; border-radius: 4px;">
            <div><strong>displayName:</strong> ${userInfo.teamsData.displayName || '[undefined]'}</div>
            <div><strong>givenName:</strong> ${userInfo.teamsData.givenName || '[undefined]'}</div>
            <div><strong>surname:</strong> ${userInfo.teamsData.surname || '[undefined]'}</div>
            <div><strong>email:</strong> ${userInfo.teamsData.email || '[undefined]'}</div>
            <div><strong>userPrincipalName:</strong> ${userInfo.teamsData.userPrincipalName || '[undefined]'}</div>
          </div>
        `;

        teamsDebugElement.innerHTML = debugContent;
      } else if (teamsDebugElement) {
        teamsDebugElement.innerHTML = `
          <div class="user-field">
            <span class="field-label">Status:</span>
            <span class="field-value" style="color: orange;">No Teams context data available</span>
          </div>
        `;
      }


      // Create ElevenLabs widget
      const widget = document.createElement('elevenlabs-convai');
      
      // Check if agent ID is properly configured
      if (AGENT_ID.startsWith('__')) {
        console.error('ElevenLabs Agent ID not properly configured. Check environment variables.');
        document.getElementById('widget').innerHTML = '<div style="color: red; padding: 20px; text-align: center;">ElevenLabs Agent ID not configured</div>';
        return;
      }
      
      widget.setAttribute('agent-id', AGENT_ID);
      widget.setAttribute('dynamic-variables', JSON.stringify({ 
        name: userInfo.name, 
        email: userInfo.email 
      }));
      document.getElementById('widget').appendChild(widget);

      // Load ElevenLabs script
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/@elevenlabs/convai-widget-embed';
      script.async = true;
      document.body.appendChild(script);

      // Start hiding attribution
      hideAttribution();
    }

    // Start when page is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
